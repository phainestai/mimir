{% extends "base.html" %}
{% load static %}

{% block title %}{{ playbook.name }} - Playbook
<script>
// Workflow search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('workflow-search');
    const filterPhases = document.getElementById('filter-has-phases');
    const table = document.getElementById('workflows-table');
    const rows = table ? table.querySelectorAll('tbody tr[data-workflow-row]') : [];
    const emptyState = document.getElementById('empty-state');
    
    function filterWorkflows() {
        if (!searchInput || !filterPhases || rows.length === 0) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const phaseFilter = filterPhases.value;
        let visibleCount = 0;
        
        rows.forEach(row => {
            const nameElement = row.querySelector('[data-workflow-name]');
            const phaseElement = row.querySelector('[data-phase-count]');
            
            const name = nameElement ? nameElement.textContent.toLowerCase() : '';
            const phaseCount = phaseElement ? parseInt(phaseElement.textContent) : 0;
            
            // Search filter
            const matchesSearch = name.includes(searchTerm);
            
            // Phase filter
            let matchesPhase = true;
            if (phaseFilter === 'with-phases') matchesPhase = phaseCount > 0;
            if (phaseFilter === 'no-phases') matchesPhase = phaseCount === 0;
            
            // Show/hide row
            if (matchesSearch && matchesPhase) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        if (emptyState && table) {
            if (visibleCount === 0 && rows.length > 0) {
                emptyState.style.display = 'block';
                table.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                table.style.display = '';
            }
        }
    }
    
    if (searchInput) searchInput.addEventListener('input', filterWorkflows);
    if (filterPhases) filterPhases.addEventListener('change', filterWorkflows);
});
</script>

{% endblock %}

{% block content %}
<div class="container mt-4" data-testid="playbook-detail">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'playbook_list' %}">Playbooks</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ playbook.name }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4" data-testid="playbook-header">
        <div>
            <h2>
                <i class="fa-solid fa-book"></i> {{ playbook.name }}
            </h2>
            <p class="text-muted">
                <span class="badge bg-{{ playbook.get_status_badge_color }}" data-testid="status-badge">{{ playbook.get_status_display }}</span>
                <span class="badge bg-secondary" data-testid="version-badge">v{{ playbook.version }}</span>
                <span class="badge bg-info">{{ playbook.get_category_display }}</span>
            </p>
            <p class="text-muted small">
                <i class="fa-solid fa-user"></i> {{ playbook.author.username }}
                <i class="fa-solid fa-clock ms-2"></i> Updated {{ playbook.updated_at|timesince }} ago
            </p>
        </div>
        <div class="btn-group">
            {% if playbook.source == 'owned' and playbook.author == request.user %}
                {% if playbook.is_draft %}
                    <!-- Edit button for draft playbooks -->
                    <a href="{% url 'playbook_edit' pk=playbook.pk %}" 
                       class="btn btn-primary"
                       data-bs-toggle="tooltip"
                       title="Edit this playbook (v{{ playbook.version }})">
                        <i class="fa-solid fa-edit"></i> Edit
                    </a>
                    <!-- Release button for draft playbooks -->
                    <button type="button" 
                            class="btn btn-success"
                            data-bs-toggle="tooltip"
                            title="Release this playbook to v1.0 (makes it read-only, changes require PIP)">
                        <i class="fa-solid fa-rocket"></i> Release
                    </button>
                {% elif playbook.is_released %}
                    <!-- Edit button disabled for released playbooks -->
                    <button type="button" 
                            class="btn btn-secondary" 
                            disabled
                            data-bs-toggle="tooltip"
                            title="Released playbooks cannot be edited directly. Please submit a PIP (Process Improvement Proposal) to make changes.">
                        <i class="fa-solid fa-edit"></i> Edit
                    </button>
                    <!-- Submit PIP button for released playbooks -->
                    <a href="#" 
                       class="btn btn-primary"
                       data-bs-toggle="tooltip"
                       title="Submit a Process Improvement Proposal to change this playbook">
                        <i class="fa-solid fa-file-lines"></i> Submit PIP
                    </a>
                {% else %}
                    <!-- Active/Disabled status - legacy, allow edit -->
                    <a href="{% url 'playbook_edit' pk=playbook.pk %}" 
                       class="btn btn-primary"
                       data-bs-toggle="tooltip"
                       title="Edit this playbook">
                        <i class="fa-solid fa-edit"></i> Edit
                    </a>
                {% endif %}
            {% endif %}
            {% if playbook.source == 'owned' and playbook.author == request.user %}
                <!-- Delete button -->
                <button type="button" 
                        class="btn btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-testid="delete-button"
                        title="Delete this playbook (cannot be undone)">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            {% endif %}
            <a href="{% url 'playbook_list' %}" 
               class="btn btn-outline-secondary"
               data-bs-toggle="tooltip"
               title="Back to playbooks list">
                <i class="fa-solid fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    data-testid="tab-overview"
                    id="overview-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#overview" 
                    type="button" 
                    role="tab">
                <i class="fa-solid fa-info-circle"></i> Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    data-testid="tab-workflows"
                    id="workflows-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#workflows-content" 
                    type="button" 
                    role="tab">
                <i class="fa-solid fa-sitemap"></i> Workflows
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    data-testid="tab-history"
                    id="history-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#history" 
                    type="button" 
                    role="tab">
                <i class="fa-solid fa-history"></i> History
            </button>
        </li>
        {% if can_edit %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    data-testid="tab-settings"
                    id="settings-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#settings" 
                    type="button" 
                    role="tab">
                <i class="fa-solid fa-cog"></i> Settings
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <!-- Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa-solid fa-align-left"></i> Description</h5>
                </div>
                <div class="card-body">
                    <p>{{ playbook.description }}</p>
                </div>
            </div>

            <!-- Quick Stats & Content Row -->
            <div class="row">
                <div class="col-md-8">
                    <!-- Quick Stats Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-chart-bar"></i> Quick Stats</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4 mb-3" data-testid="stat-workflows">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-sitemap fa-2x text-primary mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.workflows }}</h3>
                                        <small class="text-muted">Workflows</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3" data-testid="stat-phases">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-layer-group fa-2x text-info mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.phases }}</h3>
                                        <small class="text-muted">Phases</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3" data-testid="stat-activities">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-tasks fa-2x text-success mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.activities }}</h3>
                                        <small class="text-muted">Activities</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3" data-testid="stat-artifacts">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-folder fa-2x text-warning mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.artifacts }}</h3>
                                        <small class="text-muted">Artifacts</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3" data-testid="stat-roles">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-users fa-2x text-secondary mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.roles }}</h3>
                                        <small class="text-muted">Roles</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3" data-testid="stat-howtos">
                                    <div class="p-3 border rounded">
                                        <i class="fa-solid fa-lightbulb fa-2x text-danger mb-2"></i>
                                        <h3 class="mb-0">{{ quick_stats.howtos }}</h3>
                                        <small class="text-muted">Howtos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Workflows Section -->
                    <div class="card mb-4" data-testid="workflows-section">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-sitemap"></i> Workflows</h5>
                        </div>
                        <div class="card-body">
                            {% if workflows %}
                                <ul class="list-group list-group-flush">
                                    {% for workflow in workflows %}
                                        <li class="list-group-item">
                                            <i class="fa-solid fa-sitemap text-primary"></i>
                                            <strong>{{ workflow.name }}</strong>
                                            {% if workflow.description %}
                                                <p class="mb-0 text-muted small">{{ workflow.description }}</p>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0">No workflows added yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Metadata -->
                    <div class="card mb-4" data-testid="metadata-section">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-info-circle"></i> Metadata</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Category:</dt>
                                <dd class="col-sm-7">{{ playbook.get_category_display }}</dd>

                                <dt class="col-sm-5">Author:</dt>
                                <dd class="col-sm-7">{{ playbook.author.username }}</dd>

                                <dt class="col-sm-5">Created:</dt>
                                <dd class="col-sm-7">{{ playbook.created_at|timesince }} ago</dd>

                                <dt class="col-sm-5">Source:</dt>
                                <dd class="col-sm-7">{{ playbook.get_source_display }}</dd>

                                {% if playbook.tags %}
                                <dt class="col-sm-5">Tags:</dt>
                                <dd class="col-sm-7">
                                    {% for tag in playbook.tags %}
                                        <span class="badge bg-secondary">{{ tag }}</span>
                                    {% endfor %}
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflows Tab (placeholder) -->
        <div class="tab-pane fade" id="workflows-content" role="tabpanel">
            {% include "methodology/partials/workflows_tab_content.html" %}
        </div>

        <!-- History Tab (placeholder) -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <p class="text-muted">History tab content (to be implemented)</p>
        </div>

        <!-- Settings Tab (placeholder) -->
        {% if can_edit %}
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <p class="text-muted">Settings tab content (to be implemented)</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" data-testid="delete-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fa-solid fa-triangle-exclamation"></i> Delete Playbook?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <strong><i class="fa-solid fa-exclamation-triangle"></i> Warning:</strong> This action cannot be undone.
                </div>
                
                <p class="mb-3">You are about to delete:</p>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title text-danger">{{ playbook.name }}</h6>
                        <p class="card-text mb-2">
                            <small class="text-muted">
                                <i class="fa-solid fa-code-branch"></i> Version: v{{ playbook.version }}<br>
                                <i class="fa-solid fa-list"></i> Workflows: {{ playbook.workflows.count }}<br>
                                <i class="fa-solid fa-clock"></i> Last modified: {{ playbook.updated_at|timesince }} ago
                            </small>
                        </p>
                    </div>
                </div>
                
                <p class="mb-0"><strong>All of the following data will be permanently lost:</strong></p>
                <ul class="mb-3">
                    <li>All workflows and their activities</li>
                    <li>All artifacts and documentation</li>
                    <li>All roles and assignments</li>
                    <li>All howtos and guides</li>
                    <li>Version history</li>
                </ul>
                
                <p class="mb-3">
                    <i class="fa-solid fa-lightbulb text-warning"></i> 
                    <strong>Tip:</strong> Consider 
                    <a href="{% url 'playbook_export' pk=playbook.pk %}" data-testid="export-link">exporting this playbook</a> 
                    before deleting.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-testid="cancel-delete">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
                <form method="post" action="{% url 'playbook_delete' pk=playbook.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" data-testid="confirm-delete">
                        <i class="fa-solid fa-trash"></i> Delete Playbook
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .badge.bg-active { background-color: #28a745 !important; }
    .badge.bg-draft { background-color: #6c757d !important; }
    .badge.bg-disabled { background-color: #dc3545 !important; }
</style>

<script>
// Workflow search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('workflow-search');
    const filterPhases = document.getElementById('filter-has-phases');
    const table = document.getElementById('workflows-table');
    const rows = table ? table.querySelectorAll('tbody tr[data-workflow-row]') : [];
    const emptyState = document.getElementById('empty-state');
    
    function filterWorkflows() {
        if (!searchInput || !filterPhases || rows.length === 0) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const phaseFilter = filterPhases.value;
        let visibleCount = 0;
        
        rows.forEach(row => {
            const nameElement = row.querySelector('[data-workflow-name]');
            const phaseElement = row.querySelector('[data-phase-count]');
            
            const name = nameElement ? nameElement.textContent.toLowerCase() : '';
            const phaseCount = phaseElement ? parseInt(phaseElement.textContent) : 0;
            
            // Search filter
            const matchesSearch = name.includes(searchTerm);
            
            // Phase filter
            let matchesPhase = true;
            if (phaseFilter === 'with-phases') matchesPhase = phaseCount > 0;
            if (phaseFilter === 'no-phases') matchesPhase = phaseCount === 0;
            
            // Show/hide row
            if (matchesSearch && matchesPhase) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        if (emptyState && table) {
            if (visibleCount === 0 && rows.length > 0) {
                emptyState.style.display = 'block';
                table.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                table.style.display = '';
            }
        }
    }
    
    if (searchInput) searchInput.addEventListener('input', filterWorkflows);
    if (filterPhases) filterPhases.addEventListener('change', filterWorkflows);
});
</script>

<script>
// Workflow search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('workflow-search');
    const filterPhases = document.getElementById('filter-has-phases');
    const table = document.getElementById('workflows-table');
    const rows = table ? table.querySelectorAll('tbody tr[data-workflow-row]') : [];
    const emptyState = document.getElementById('empty-state');
    
    function filterWorkflows() {
        if (!searchInput || !filterPhases || rows.length === 0) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const phaseFilter = filterPhases.value;
        let visibleCount = 0;
        
        rows.forEach(row => {
            const nameElement = row.querySelector('[data-workflow-name]');
            const phaseElement = row.querySelector('[data-phase-count]');
            
            const name = nameElement ? nameElement.textContent.toLowerCase() : '';
            const phaseCount = phaseElement ? parseInt(phaseElement.textContent) : 0;
            
            // Search filter
            const matchesSearch = name.includes(searchTerm);
            
            // Phase filter
            let matchesPhase = true;
            if (phaseFilter === 'with-phases') matchesPhase = phaseCount > 0;
            if (phaseFilter === 'no-phases') matchesPhase = phaseCount === 0;
            
            // Show/hide row
            if (matchesSearch && matchesPhase) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty state
        if (emptyState && table) {
            if (visibleCount === 0 && rows.length > 0) {
                emptyState.style.display = 'block';
                table.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                table.style.display = '';
            }
        }
    }
    
    if (searchInput) searchInput.addEventListener('input', filterWorkflows);
    if (filterPhases) filterPhases.addEventListener('change', filterWorkflows);
});
</script>

{% endblock %}
